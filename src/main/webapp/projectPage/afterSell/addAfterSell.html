<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
    <style>
        body {
            background-color: #ffffff;
        }
        #sub{
            position: absolute;
            left: 600px;
        }
    </style>
</head>
<body>

<button class="layui-btn layui-btn-sm data-add-btn" id="but"> 返回 </button>

<form class="layui-form" action="" method="post" id="add-user-form">
    <hr><h2>基本信息</h2><hr>

    <div class="layui-form-item">
        <label class="layui-form-label">主题:</label>
        <div class="layui-input-block">
            <input type="text" disabled="disabled" id="theme"  placeholder="无需输入，自动生成！！！" autocomplete="off" class="layui-input">
            <input type="hidden" id="a">
            <input type="hidden" id="b">
        </div>
        <br>
        <div class="layui-input-block">
            <p>步骤：服务登记</p>
        </div>
    </div>

    <hr><h2>售后服务信息</h2><hr>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">客户名称:</label>
            <div class="layui-input-inline">
                <select class="layui-form-select" lay-verify="required" id="customerId" name="customerId" lay-filter="customerId"></select>
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">合同编号:</label>
            <div class="layui-input-inline">
                <select class="layui-form-select" id="cid" name="cid" lay-filter="select2"></select>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">售后要点:</label>
        <div class="layui-input-block">
            <input type="text" name="contractInfor" lay-verify="required"  autocomplete="off" placeholder="主要信息" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">对方联系人:</label>
            <div class="layui-input-inline">
                <input type="text" name="linkman" lay-verify="required"  autocomplete="off" placeholder="对方联系人" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">固定电话:</label>
            <div class="layui-input-inline">
                <input type="text" name="officeno" lay-verify="required|number"  autocomplete="off" placeholder="固定电话" class="layui-input">
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">移动电话:</label>
            <div class="layui-input-inline">
                <input type="text" name="phoneno" lay-verify="required|number"  autocomplete="off" placeholder="移动电话" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">邮件/QQ:</label>
            <div class="layui-input-inline">
                <input type="text" name="emails" lay-verify="required|emails"  autocomplete="off" placeholder="主要信息" class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">服务类型:</label>
            <div class="layui-input-inline">
                <select id='serviceType' name='serviceType' class='layui-form-select'>
                    <option value='0'>请选择</option>
                    <option value='主动关怀'>主动关怀</option>
                    <option value='实施或培训'>实施或培训</option>
                    <option value='业务咨询'>业务咨询</option>
                    <option value='故障申报'>故障申报</option>
                    <option value='其他'>其他</option>
                </select>
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">服务方式:</label>
            <div class="layui-input-inline">
                <select id='serviceStyle' name='serviceStyle' class='layui-form-select'>
                    <option value='0'>请选择</option>
                    <option value='上门服务'>上门服务</option>
                    <option value='网上远程'>线上解决</option>
                    <option value='邮寄服务'>远程服务</option>
                    <option value='其他'>其他</option>
                </select>
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">开始时间:</label>
            <div class="layui-input-inline">
                <input type='text' id='starttime' class='layui-input' name='starttime' placeholder='yyyy-MM-dd'>
            </div>
        </div>

        <div class="layui-inline">
            <label class="layui-form-label">结束时间:</label>
            <div class="layui-input-inline">
                <input type='text' id='endtime' class='layui-input' name='endtime' placeholder='yyyy-MM-dd'>
            </div>
        </div>
    </div>


    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">服务内容:</label>
        <div class="layui-input-block">
            <textarea name="serviceText" lay-verify="required" placeholder="服务内容" class="layui-textarea"></textarea>
        </div>
    </div>

    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">客户反馈:</label>
        <div class="layui-input-block">
            <textarea name="customerReturn" lay-verify="required" placeholder="客户反馈" class="layui-textarea"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">服务人员:</label>
                <div class="layui-input-block" id="username" name="username"></div>
        </div>

        <div class="layui-inline">
            <label class="layui-form-label">评分:</label>

                <input type="radio" name="serviceScore" value="5" title="5" >
                <input type="radio" name="serviceScore" value="4" title="4" >
                <input type="radio" name="serviceScore" value="3" title="3" >
                <input type="radio" name="serviceScore" value="2" title="2" >
                <input type="radio" name="serviceScore" value="1" title="1" >

        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">附件:</label>
        <div class="layui-upload">
            <button type="button"  class="layui-btn layui-btn-normal" id="uploadFile">选择文件</button>
            <button type="button" class="layui-btn" id="test9">开始上传</button>
        </div>
        <input type="hidden" id="hidd" name="file">
    </div>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <div class="layui-form-item" id="sub">

            <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>

    </div>

</form>


<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script>
    layui.config({
    }).extend({
        selectN:'../../layui/layui_extends/selectN',
        selectM:'../../layui/layui_extends/selectM',
    }).use(['form','selectM','laydate','upload'], function () {
        var form = layui.form,
            layer = layui.layer,
            selectM = layui.selectM,
            laydate = layui.laydate,
            upload = layui.upload,
            $ = layui.$;

        //多选标签-基本配置
        selectM({
            //元素容器【必填】
            elem: '#username'
            //候选数据【必填】
            ,data: '../../afterSell/selectUser.do'
            ,max:3//可以选几个
            ,width:400
            ,delimiter:','
            ,field:{idName:'username',titleName:'username'}
            //添加验证
            ,verify:'required'
        });


        $("#but").click(function(){
            window.parent.location.reload();

        });
        //时间
        laydate.render({
            elem: '#starttime'//指定元素
        });
        laydate.render({
            elem: '#endtime'//指定元素
        });
        //添加文件

        //选完文件后不自动上传
        upload.render({
            elem: '#uploadFile'
            ,url: '../../afterSell/uploadFile.do' //改成您自己的上传接口
            ,auto: false
            //,multiple: true
            ,accept: 'file'
            ,bindAction: '#test9'
            ,done: function(res){
                var va=res.filename;
                $("#hidd").val(va);
                layer.msg('上传成功');
                console.log(res)
            } ,error: function(){
                layer.msg("失败");
            }
        });


        $.ajax({
            type:"post",
            url:"../../afterSell/selectCustomer.do",
            contentType:"application/json",
            success:function (datas) {
                s="<option value='0'>请选择</option>";
                for (var j=0;j<datas.length;j++){
                    s+="<option value='"+datas[j].cid+"'>"+datas[j].cname+"</option>";
                }
                $("#customerId").append(s);
                layui.form.render();
            }
        });

        //监听提交
        form.on('submit(formDemo)', function (data) {
            // ajax方式添加用户
            //layer.msg(JSON.stringify(data.field));
            $.ajax({
                url: "../../afterSell/insert.do",
                type: "post",
                data: data.field,
                dataType: 'json',
                success:function (data) {
                    if(data == 0){
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        setTimeout(function () {
                            parent.layer.close(index);
                        },1100);

                        layer.msg("添加成功",{

                            icon:1,
                            time:1000
                        },function() {
                            //do...
                            parent.location.reload();
                        });

                    }
                }

            });
            // 阻止表单跳转
            return false;
        });

        //监听select
        form.on('select(customerId)', function (obj) {
            //根据客户id 去查找合同
             $("#cid").empty();
            $.ajax({
                type:"post",
                url:"../../afterSell/selectContractByCustomerId.do?customerId="+obj.value,
                contentType:"application/json",
                success:function (datas) {
                    s="<option value='0'>请选择</option>";
                    for (var j=0;j<datas.length;j++){
                        s+="<option value='"+datas[j].cid+"'>"+datas[j].contractNum+"</option>";
                    }
                    $("#cid").append(s);
                    layui.form.render();
                }
            });
        });

        //监听select

        form.on('select(select2)', function (obj) {
            var c=$("#customerId").val();
            var contract=obj.value;
            $.ajax({
                type:"post",
                url:"../../afterSell/selectCustomerById.do?cid="+c,
                contentType:"application/json",
                success:function (datas) {
                 $("#a").val(datas[0].cname);
                }
            });
            $.ajax({
                type:"post",
                url:"../../afterSell/selectContractNumByCustomerId.do?cid="+contract,
                contentType:"application/json",
                success:function (datas) {
                    $("#b").val(datas.contractNum);
                }
            });
            var aa=document.getElementById("a").value;
        });

    });
</script>

</body>
</html>